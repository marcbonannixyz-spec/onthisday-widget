<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>On This Day Headlines</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
input { padding: 6px; }
button { padding: 6px 10px; margin-left: 6px; }
h3 { margin-top: 18px; }
ul { margin-top: 6px; }
</style>
</head>
<body>

<label>Date (YYYY-MM-DD):</label>
<input id="d" value="1969-07-20">
<button onclick="run(true)">All</button>
<button onclick="run(false)">Events Only</button>

<div id="out"></div>

<script>
const EXEC = "https://script.google.com/macros/s/AKfycbwBLSAHrDL4ussd2iwyD1TTxRgt5BZpg_T92XChf92Ou4I8QiCGqfLJzmG_SnJgkBhp/exec";

function esc(s) {
  return String(s).replace(/[&<>"]/g, c => ({
    '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;'
  }[c]));
}

function jsonp(url) {
  return new Promise((resolve, reject) => {
    const callbackName = "cb_" + Math.random().toString(36).slice(2);

    // cache-bust helps across browsers/CDNs
    const fullUrl = url + "&callback=" + callbackName + "&_=" + Date.now();

    window[callbackName] = (data) => {
      try { resolve(data); }
      finally {
        delete window[callbackName];
        script.remove();
      }
    };

    const script = document.createElement("script");
    script.src = fullUrl;
    script.async = true;

    script.onerror = () => {
      delete window[callbackName];
      script.remove();
      reject(new Error("JSONP load failed (script.onerror)."));
    };

    document.body.appendChild(script);
  });
}

async function run(all) {
  const date = document.getElementById("d").value.trim();
  const out = document.getElementById("out");
  out.innerHTML = "Loadingâ€¦";

  const url = `${EXEC}?api=1&date=${encodeURIComponent(date)}&all=${all ? 1 : 0}`;

  try {
    const response = await jsonp(url);
    if (!response || response.ok !== true) {
      throw new Error((response && response.error) ? response.error : "API returned no ok:true");
    }

    const d = response.data;

    let html = "<h3>Events</h3><ul>";
    (d.events || []).forEach(x => html += "<li>" + esc(x) + "</li>");
    html += "</ul>";

    if (all) {
      html += "<h3>Births</h3><ul>";
      (d.births || []).forEach(x => html += "<li>" + esc(x) + "</li>");
      html += "</ul>";

      html += "<h3>Deaths</h3><ul>";
      (d.deaths || []).forEach(x => html += "<li>" + esc(x) + "</li>");
      html += "</ul>";
    }

    out.innerHTML = html;

  } catch (err) {
    // This will NEVER be "undefined" again
    out.innerHTML =
      "<p style='color:#b00020;font-weight:600;'>" +
      "Error: " + esc(err && err.message ? err.message : String(err)) +
      "</p>";
  }
}
</script>
</body>

</html>

