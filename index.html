<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>On This Day Headlines</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
input { padding: 6px; }
button { padding: 6px 10px; margin-left: 6px; }
h3 { margin-top: 18px; }
ul { margin-top: 6px; }
</style>
</head>
<body>

<label>Date (YYYY-MM-DD):</label>
<input id="d" value="1969-07-20">
<button onclick="run(true)">All</button>
<button onclick="run(false)">Events Only</button>

<div id="out"></div>

<script>

const EXEC = "https://script.google.com/macros/s/AKfycbwBLSAHrDL4ussd2iwyD1TTxRgt5BZpg_T92XChf92Ou4I8QiCGqfLJzmG_SnJgkBhp/exec";

function esc(s) {
  return String(s).replace(/[&<>"]/g, c => ({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;'
  }[c]));
}

function jsonp(url) {
  return new Promise((resolve, reject) => {

    const callbackName = "cb_" + Math.random().toString(36).substring(2);

    window[callbackName] = function(data) {
      resolve(data);
      delete window[callbackName];
      script.remove();
    };

    const script = document.createElement("script");
    script.src = url + "&callback=" + callbackName;
    script.onerror = reject;

    document.body.appendChild(script);
  });
}

async function run(all) {

  const date = document.getElementById("d").value;
  const url = `${EXEC}?api=1&date=${date}&all=${all ? 1 : 0}`;

  const out = document.getElementById("out");
  out.innerHTML = "Loading...";

  try {

    const response = await jsonp(url);

    if (!response.ok) {
      throw new Error(response.error || "Unknown error");
    }

    const d = response.data;

    let html = "<h3>Events</h3><ul>";
    (d.events || []).forEach(x => html += "<li>" + esc(x) + "</li>");
    html += "</ul>";

    if (all) {
      html += "<h3>Births</h3><ul>";
      (d.births || []).forEach(x => html += "<li>" + esc(x) + "</li>");
      html += "</ul>";

      html += "<h3>Deaths</h3><ul>";
      (d.deaths || []).forEach(x => html += "<li>" + esc(x) + "</li>");
      html += "</ul>";
    }

    out.innerHTML = html;

  } catch (err) {
    out.innerHTML = "<p style='color:red;'>Error: " + esc(err.message) + "</p>";
  }
}

</script>

</body>

</html>
